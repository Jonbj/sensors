version: '3.8'

########################################
# STACK:
# - Traefik (reverse proxy + TLS)
# - Mosquitto (MQTT, TLS terminato da Traefik)
# - InfluxDB (time-series DB)
# - Grafana (dashboard)
# - Node-RED (orchestrazione, PROTETTO)
# - Portainer (gestione Docker)
########################################

services:

  ########################################
  # TRAEFIK
  ########################################
  traefik:
    image: traefik:v3.0
    container_name: traefik

    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"

      # EntryPoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.mqtts.address=:8883"

      # Redirect HTTP â†’ HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      # Let's Encrypt
      - "--certificatesresolvers.le.acme.email=admin@vlnet.me"
      - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"

    ports:
      - "80:80"
      - "443:443"
      - "8883:8883"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - traefik-letsencrypt:/letsencrypt

    restart: unless-stopped

  ########################################
  # MQTT - MOSQUITTO
  ########################################
  mqtt:
    image: eclipse-mosquitto:2.0.18
    container_name: mqtt-broker

    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log

    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.mqtts.rule=HostSNI(`mqtt.vlnet.me`)"
      - "traefik.tcp.routers.mqtts.entrypoints=mqtts"
      - "traefik.tcp.routers.mqtts.tls=true"
      - "traefik.tcp.routers.mqtts.tls.certresolver=le"
      - "traefik.tcp.services.mqtts.loadbalancer.server.port=1883"

    restart: unless-stopped

  ########################################
  # INFLUXDB
  ########################################
  influxdb:
    image: influxdb:2.7
    container_name: influxdb

    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-backup:/backup

    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_USER}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_TOKEN}

    restart: unless-stopped

  ########################################
  # GRAFANA
  ########################################
  grafana:
    image: grafana/grafana-oss:10
    container_name: grafana

    volumes:
      - grafana-storage:/var/lib/grafana

    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.vlnet.me`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=le"

    depends_on:
      - influxdb

    restart: unless-stopped

  ########################################
  # NODE-RED (PROTETTO)
  ########################################
  nodered:
    image: nodered/node-red:3.1
    container_name: nodered

    volumes:
      - ./nodered-data:/data

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nodered.rule=Host(`nodered.vlnet.me`)"
      - "traefik.http.routers.nodered.entrypoints=websecure"
      - "traefik.http.routers.nodered.tls.certresolver=le"

    depends_on:
      - mqtt
      - influxdb

    restart: unless-stopped

  ########################################
  # PORTAINER
  ########################################
  portainer:
    image: portainer/portainer-ce:2.19.5
    container_name: portainer

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.vlnet.me`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=le"

    restart: unless-stopped

volumes:
  influxdb-data:
  influxdb-backup:
  grafana-storage:
  portainer-data:
  traefik-letsencrypt:

